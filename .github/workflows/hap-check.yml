name: HAP Attestation Check

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]

jobs:
  check_attestation:
    name: Verify HAP Attestation
    if: github.event.pull_request || (github.event.issue.pull_request && contains(github.event.comment.body, 'HAP_ATTESTATION'))
    runs-on: ubuntu-latest
    steps:
      - name: Check for valid attestation
        uses: actions/github-script@v7
        with:
          script: |
            let pr;

            if (context.payload.pull_request) {
              pr = context.payload.pull_request;
            } else {
              const { data } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });
              pr = data;
            }

            const headSha = pr.head.sha;
            console.log(`Checking attestation for PR #${pr.number}, SHA: ${headSha}`);

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });

            const beginMarker = '---BEGIN HAP_ATTESTATION v=1---';
            const endMarker = '---END HAP_ATTESTATION---';
            let found = false;
            let attestationDetails = null;

            for (const comment of comments.data) {
              const body = comment.body || '';
              const beginIdx = body.indexOf(beginMarker);
              const endIdx = body.indexOf(endMarker);

              if (beginIdx === -1 || endIdx === -1) continue;

              const block = body.slice(beginIdx + beginMarker.length, endIdx).trim();
              const lines = block.split('\n').map(l => l.trim());
              const data = {};

              for (const line of lines) {
                const eq = line.indexOf('=');
                if (eq > 0) data[line.slice(0, eq)] = line.slice(eq + 1);
              }

              console.log(`Found attestation in comment ${comment.id}:`);
              console.log(`  SHA: ${data.sha}`);
              console.log(`  Profile: ${data.profile}`);

              if (data.sha === headSha) {
                found = true;
                attestationDetails = data;
                console.log(`✓ SHA matches!`);
                break;
              } else {
                console.log(`✗ SHA mismatch (expected ${headSha})`);
              }
            }

            if (!found) {
              core.setFailed(`No valid HAP attestation found for SHA ${headSha.slice(0,7)}. A human must review and attest before merge.`);
            } else {
              console.log('');
              console.log('='.repeat(50));
              console.log('✓ Valid HAP attestation found');
              console.log(`  Profile: ${attestationDetails.profile}`);
              console.log(`  Environment: ${attestationDetails.env}`);
              console.log(`  Execution Path: ${attestationDetails.path}`);
              console.log(`  Frame Hash: ${attestationDetails.frame_hash}`);
              console.log('='.repeat(50));
            }
