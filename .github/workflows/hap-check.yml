name: HAP Attestation Check

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]

env:
  HAP_SERVICE_URL: https://service.humanagencyprotocol.org

jobs:
  check_attestation:
    name: Verify HAP Attestation
    if: github.event.pull_request || (github.event.issue.pull_request && contains(github.event.comment.body, 'HAP_ATTESTATION'))
    runs-on: ubuntu-latest
    steps:
      - name: Find and verify attestations
        uses: actions/github-script@v7
        with:
          script: |
            let pr;

            if (context.payload.pull_request) {
              pr = context.payload.pull_request;
            } else {
              const { data } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });
              pr = data;
            }

            const headSha = pr.head.sha;
            const repo = `${context.repo.owner}/${context.repo.repo}`;
            console.log(`Checking attestations for PR #${pr.number}`);
            console.log(`  Repo: ${repo}`);
            console.log(`  SHA: ${headSha}`);

            // Find all attestations in PR comments
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });

            const beginMarker = '---BEGIN HAP_ATTESTATION v=1---';
            const endMarker = '---END HAP_ATTESTATION---';

            // Collect all valid attestations for this SHA
            const attestations = [];
            let executionPath = null;

            for (const comment of comments.data) {
              const body = comment.body || '';
              const beginIdx = body.indexOf(beginMarker);
              const endIdx = body.indexOf(endMarker);

              if (beginIdx === -1 || endIdx === -1) continue;

              const block = body.slice(beginIdx + beginMarker.length, endIdx).trim();
              const lines = block.split('\n').map(l => l.trim());
              const data = {};

              for (const line of lines) {
                const eq = line.indexOf('=');
                if (eq > 0) data[line.slice(0, eq)] = line.slice(eq + 1);
              }

              console.log(`\nFound attestation in comment ${comment.id}:`);
              console.log(`  SHA in attestation: ${data.sha}`);
              console.log(`  Profile: ${data.profile}`);
              console.log(`  Role: ${data.role || 'engineering'}`);
              console.log(`  Path: ${data.path}`);

              // Check SHA match
              if (data.sha !== headSha) {
                console.log(`  ✗ SHA mismatch (PR head is ${headSha})`);
                continue;
              }

              console.log(`  ✓ SHA matches`);

              // Store execution path (should be same for all attestations)
              if (data.path) {
                executionPath = data.path;
              }

              attestations.push({
                ...data,
                commentId: comment.id,
                user: comment.user?.login,
                role: data.role || 'engineering' // Default to engineering for backwards compatibility
              });
            }

            if (attestations.length === 0) {
              core.setFailed(`No HAP attestation found for SHA ${headSha.slice(0,7)}. A human must review and attest before merge.`);
              return;
            }

            // Determine required roles based on execution path
            const requiredRoles = executionPath === 'full'
              ? ['engineering', 'release_management']
              : ['engineering'];

            console.log(`\nExecution path: ${executionPath || 'canary'}`);
            console.log(`Required roles: ${requiredRoles.join(', ')}`);

            // Verify each attestation and track which roles are covered
            const verifiedRoles = new Set();
            const verifyUrl = `${process.env.HAP_SERVICE_URL}/api/sp/verify`;

            for (const attestation of attestations) {
              console.log(`\nVerifying ${attestation.role} attestation from ${attestation.user}...`);

              const response = await fetch(verifyUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  attestation: attestation.blob,
                  expected_frame_hash: attestation.frame_hash
                })
              });

              const result = await response.json();

              if (!result.valid) {
                console.log(`  ✗ Verification failed: ${result.error} - ${result.reason}`);
                continue;
              }

              // Check expiry
              const now = Math.floor(Date.now() / 1000);
              if (result.payload.expires_at < now) {
                console.log(`  ✗ Attestation has expired`);
                continue;
              }

              console.log(`  ✓ Valid attestation`);
              console.log(`    Attestation ID: ${result.payload.attestation_id}`);
              console.log(`    Issued: ${new Date(result.payload.issued_at * 1000).toISOString()}`);
              console.log(`    Expires: ${new Date(result.payload.expires_at * 1000).toISOString()}`);

              verifiedRoles.add(attestation.role);
            }

            // Check if all required roles are covered
            const missingRoles = requiredRoles.filter(r => !verifiedRoles.has(r));

            if (missingRoles.length > 0) {
              console.log('');
              console.log('='.repeat(50));
              console.log('✗ Missing Required Attestations');
              console.log('='.repeat(50));
              console.log(`  Verified roles: ${[...verifiedRoles].join(', ') || 'none'}`);
              console.log(`  Missing roles: ${missingRoles.join(', ')}`);
              console.log('='.repeat(50));

              const roleLabels = {
                'engineering': 'Engineering',
                'release_management': 'Release Management'
              };
              const missingLabels = missingRoles.map(r => roleLabels[r] || r).join(', ');
              core.setFailed(`Missing attestations from: ${missingLabels}. All required approvals must be obtained before merge.`);
              return;
            }

            // Success!
            console.log('');
            console.log('='.repeat(50));
            console.log('✓ All HAP Attestations Verified');
            console.log('='.repeat(50));
            console.log(`  Execution Path: ${executionPath || 'canary'}`);
            console.log(`  Verified Roles: ${[...verifiedRoles].join(', ')}`);
            console.log(`  Total Attestations: ${attestations.length}`);
            console.log('='.repeat(50));
