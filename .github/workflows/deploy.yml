name: Deploy via HAP

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request number'
        required: true
        type: string

env:
  HAP_PROXY_URL: ${{ secrets.HAP_PROXY_URL }}
  HAP_PROXY_TOKEN: ${{ secrets.HAP_PROXY_TOKEN }}

jobs:
  hap_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Build hap-core
        run: pnpm --filter @hap-demo/core build

      - name: Fetch PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt('${{ inputs.pr_number }}'),
            });
            core.setOutput('head_sha', pr.data.head.sha);
            core.setOutput('repo', `${context.repo.owner}/${context.repo.repo}`);
            console.log(`PR #${{ inputs.pr_number }}: ${pr.data.title}`);
            console.log(`Head SHA: ${pr.data.head.sha}`);

      - name: Find HAP attestation in PR comments
        id: attestation
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt('${{ inputs.pr_number }}'),
            });

            const headSha = '${{ steps.pr.outputs.head_sha }}';
            const beginMarker = '---BEGIN HAP_ATTESTATION v=1---';
            const endMarker = '---END HAP_ATTESTATION---';

            let latestAttestation = null;
            let latestTimestamp = 0;

            for (const comment of comments.data) {
              const body = comment.body || '';
              const beginIdx = body.indexOf(beginMarker);
              const endIdx = body.indexOf(endMarker);

              if (beginIdx === -1 || endIdx === -1) continue;

              const block = body.slice(beginIdx + beginMarker.length, endIdx).trim();
              const lines = block.split('\n').map(l => l.trim());
              const data = {};
              for (const line of lines) {
                const eq = line.indexOf('=');
                if (eq > 0) data[line.slice(0, eq)] = line.slice(eq + 1);
              }

              // Check SHA match
              if (data.sha !== headSha) {
                console.log(`Skipping comment ${comment.id}: SHA mismatch (${data.sha} != ${headSha})`);
                continue;
              }

              // Check profile
              if (data.profile !== 'deploy-gate@0.2') {
                console.log(`Skipping comment ${comment.id}: wrong profile (${data.profile})`);
                continue;
              }

              const timestamp = new Date(comment.created_at).getTime();
              if (timestamp > latestTimestamp) {
                latestTimestamp = timestamp;
                latestAttestation = data;
                console.log(`Found attestation in comment ${comment.id}`);
              }
            }

            if (!latestAttestation) {
              core.setFailed('No valid HAP attestation found for head SHA');
              return;
            }

            core.setOutput('profile', latestAttestation.profile);
            core.setOutput('env', latestAttestation.env);
            core.setOutput('path', latestAttestation.path);
            core.setOutput('sha', latestAttestation.sha);
            core.setOutput('frame_hash', latestAttestation.frame_hash);
            core.setOutput('disclosure_hash', latestAttestation.disclosure_hash);
            core.setOutput('blob', latestAttestation.blob);

            console.log('Attestation found:');
            console.log(`  Profile: ${latestAttestation.profile}`);
            console.log(`  Path: ${latestAttestation.path}`);
            console.log(`  SHA: ${latestAttestation.sha}`);

      - name: Call HAP Proxy
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$HAP_PROXY_URL/api/proxy/execute/deploy" \
            -H "Authorization: Bearer $HAP_PROXY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "attestation": "${{ steps.attestation.outputs.blob }}",
              "payload": {
                "template_id": "deploy-prod-v1",
                "params": {
                  "repo": "${{ steps.pr.outputs.repo }}",
                  "sha": "${{ steps.attestation.outputs.sha }}",
                  "env": "${{ steps.attestation.outputs.env }}",
                  "profile_id": "${{ steps.attestation.outputs.profile }}",
                  "execution_path": "${{ steps.attestation.outputs.path }}",
                  "disclosure_hash": "${{ steps.attestation.outputs.disclosure_hash }}"
                }
              }
            }')

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Deploy failed with status $HTTP_CODE"
            exit 1
          fi

          echo "Deploy successful!"
          echo "$BODY" | jq -r '.prod_url // empty' | xargs -I {} echo "View at: {}"

      - name: Summary
        run: |
          echo "## HAP Deploy Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PR:** #${{ inputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA:** \`${{ steps.attestation.outputs.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Path:** ${{ steps.attestation.outputs.path }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Prod URL:** $HAP_PROXY_URL/prod" >> $GITHUB_STEP_SUMMARY
